---
sidebar_position: 4
title: Coordinate Frames and TF
description: Understanding coordinate transformations in robotics
keywords: [ros2, urdf, tf, transforms, coordinate frames, kinematics]
---

# Coordinate Frames and TF

Master coordinate frames and the TF (Transform) system for understanding where robot parts are in space.

## What are Coordinate Frames?

:::tip Definition

A **coordinate frame** is a 3D coordinate system attached to a link. Every link has its own frame defining position and orientation.

:::

**Components**:
- **Origin**: Position (x, y, z)
- **Orientation**: Rotation (roll, pitch, yaw)
- **Axes**: X (forward/red), Y (left/green), Z (up/blue)

## Right-Hand Coordinate System

```
         Z (up)
         ↑
         |
         |
         └────→ X (forward)
        /
       /
      ↓
      Y (left)
```

**Standard conventions**:
- X: Forward direction
- Y: Left direction
- Z: Upward direction

## Joint Transformations

Joints define the transformation from parent to child frame:

```xml
<joint name="shoulder" type="revolute">
  <parent link="torso"/>
  <child link="upper_arm"/>
  <origin xyz="0 0.3 0.5" rpy="0 0 0"/>
  <!-- Child frame is at (0, 0.3, 0.5) relative to parent -->
</joint>
```

**The `<origin>` tag**:
1. Start at parent link's frame
2. Translate by (x, y, z) meters
3. Rotate by (roll, pitch, yaw) radians
4. Result is child link's frame location

## Transform Chain Example

```xml
<robot name="simple_chain">
  <link name="base_link"/>

  <link name="link1"/>
  <joint name="joint1" type="fixed">
    <parent link="base_link"/>
    <child link="link1"/>
    <origin xyz="1 0 0" rpy="0 0 0"/>
  </joint>

  <link name="link2"/>
  <joint name="joint2" type="fixed">
    <parent link="link1"/>
    <child link="link2"/>
    <origin xyz="0 0 0.5" rpy="0 0 0"/>
  </joint>
</robot>
```

**Frame positions**:
- `base_link`: (0, 0, 0)
- `link1`: (1, 0, 0) in base_link frame
- `link2`: (1, 0, 0.5) in base_link frame

## TF System (Transform Tree)

The **TF system** manages coordinate transformations between all frames.

### robot_state_publisher

Broadcasts TF transforms from URDF + joint states:

**Inputs**:
- URDF (robot structure)
- `/joint_states` topic (current joint angles)

**Outputs**:
- TF tree (all coordinate frame relationships)

**Example launch**:
```python
from launch import LaunchDescription
from launch_ros.actions import Node
import os
from ament_index_python.packages import get_package_share_directory

def generate_launch_description():
    urdf_file = os.path.join(
        get_package_share_directory('my_robot_description'),
        'urdf', 'my_robot.urdf'
    )

    with open(urdf_file, 'r') as file:
        robot_desc = file.read()

    return LaunchDescription([
        Node(
            package='robot_state_publisher',
            executable='robot_state_publisher',
            output='screen',
            parameters=[{'robot_description': robot_desc}]
        ),
        Node(
            package='joint_state_publisher',
            executable='joint_state_publisher',
            output='screen'
        )
    ])
```

## Querying Transforms

### CLI Tools

```bash
# View TF tree
ros2 run tf2_tools view_frames

# Echo transform between frames
ros2 run tf2_ros tf2_echo base_link end_effector

# List all frames
ros2 run tf2_ros tf2_monitor
```

### Python API

```python
import rclpy
from rclpy.node import Node
from tf2_ros import TransformListener, Buffer

class TFListenerNode(Node):
    def __init__(self):
        super().__init__('tf_listener')

        # Create TF buffer and listener
        self.tf_buffer = Buffer()
        self.tf_listener = TransformListener(self.tf_buffer, self)

        self.create_timer(1.0, self.query_transform)

    def query_transform(self):
        try:
            # Get transform from base_link to end_effector
            transform = self.tf_buffer.lookup_transform(
                'base_link',        # Target frame
                'end_effector',     # Source frame
                rclpy.time.Time()   # Latest available
            )

            # Extract translation
            t = transform.transform.translation
            self.get_logger().info(
                f'Position: x={t.x:.2f}, y={t.y:.2f}, z={t.z:.2f}'
            )

        except Exception as e:
            self.get_logger().warn(f'Transform not available: {e}')
```

## Publishing Custom Transforms

```python
import rclpy
from rclpy.node import Node
from tf2_ros import TransformBroadcaster
from geometry_msgs.msg import TransformStamped

class CustomTFPublisher(Node):
    def __init__(self):
        super().__init__('custom_tf_publisher')
        self.tf_broadcaster = TransformBroadcaster(self)
        self.create_timer(0.1, self.publish_transform)

    def publish_transform(self):
        t = TransformStamped()

        # Header
        t.header.stamp = self.get_clock().now().to_msg()
        t.header.frame_id = 'base_link'
        t.child_frame_id = 'detected_object'

        # Translation
        t.transform.translation.x = 1.0
        t.transform.translation.y = 0.5
        t.transform.translation.z = 0.3

        # Rotation (quaternion: no rotation)
        t.transform.rotation.w = 1.0

        self.tf_broadcaster.sendTransform(t)
```

## Rotations: Quaternions vs Euler Angles

### Euler Angles (Roll, Pitch, Yaw)

URDF uses RPY format:

```xml
<origin xyz="0 0 0" rpy="0.785 0 1.571"/>
<!-- roll=45°, pitch=0°, yaw=90° -->
```

**Pros**: Intuitive
**Cons**: Gimbal lock

### Quaternions

TF uses quaternions (x, y, z, w):

```python
transform.rotation.z = 0.707
transform.rotation.w = 0.707
# 90° rotation around Z-axis
```

**Pros**: No gimbal lock
**Cons**: Not intuitive

### Conversion

```python
from tf_transformations import quaternion_from_euler, euler_from_quaternion
import math

# Euler to Quaternion
roll, pitch, yaw = 0.0, 0.0, math.pi/2
quat = quaternion_from_euler(roll, pitch, yaw)

# Quaternion to Euler
euler = euler_from_quaternion([qx, qy, qz, qw])
```

## Common Frame Conventions

### base_link

The **root frame** of the robot (center of robot base).

### base_footprint

Projection of `base_link` onto the ground:

```xml
<link name="base_footprint"/>

<joint name="base_joint" type="fixed">
  <parent link="base_footprint"/>
  <child link="base_link"/>
  <origin xyz="0 0 0.1" rpy="0 0 0"/>
</joint>
```

### odom and map

```
map → odom → base_footprint → base_link → ...
```

- **odom**: World-fixed frame for odometry
- **map**: World-fixed frame for mapping/localization

## Transform Lookup Example

```python
from tf2_geometry_msgs import do_transform_point
from geometry_msgs.msg import PointStamped

# Point in camera frame
point_camera = PointStamped()
point_camera.header.frame_id = 'camera_link'
point_camera.header.stamp = self.get_clock().now().to_msg()
point_camera.point.x = 1.0

# Get transform
transform = self.tf_buffer.lookup_transform(
    'base_link',
    'camera_link',
    rclpy.time.Time()
)

# Transform point
point_base = do_transform_point(point_camera, transform)
```

## Best Practices

:::tip TF Best Practices

1. **Single TF tree** - All frames must connect
2. **No cycles** - Tree must be acyclic
3. **One publisher per transform** - Avoid conflicts
4. **Base_link as root** - Standard convention
5. **REP-105 compliance** - Follow ROS standards
6. **Z-axis up** - Right-hand rule
7. **Update rate** - Publish faster than needed

:::

## Debugging TF Issues

### Common Errors

**"Frame X does not exist"**
- Solution: Check `ros2 run tf2_tools view_frames`

**"Transform timeout"**
- Solution: Verify `robot_state_publisher` is running

### Debug Commands

```bash
# Visualize TF tree
ros2 run tf2_tools view_frames
evince frames.pdf

# Monitor TF messages
ros2 topic echo /tf

# Check specific transform
ros2 run tf2_ros tf2_echo parent_frame child_frame
```

## Key Takeaways

:::note Summary

- **Coordinate frames** define position and orientation
- **Right-hand rule**: X forward, Y left, Z up
- **Joint `<origin>`** defines parent-to-child transformation
- **TF system** manages all coordinate transformations
- **robot_state_publisher** broadcasts TF from URDF
- **TransformListener** receives transforms
- **TransformBroadcaster** publishes custom transforms
- **Quaternions** used internally, **Euler angles** in URDF
- **Common frames**: base_link, base_footprint, odom, map
- **Tools**: view_frames, tf2_echo, tf2_monitor

:::

---

**Next**: [Humanoid Robot URDF →](./humanoid-urdf)

**Previous**: [← Links and Joints](./links-joints)
